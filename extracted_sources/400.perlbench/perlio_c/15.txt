AV *
PerlIO_get_layers(pTHX_ PerlIO *f)
{
     AV *av = newAV();

     if (PerlIOValid(f)) {
	  PerlIOl *l = PerlIOBase(f);

	  while (l) {
	       SV *name = l->tab && l->tab->name ?
		    newSVpv(l->tab->name, 0) : &PL_sv_undef;
	       SV *arg = l->tab && l->tab->Getarg ?
		    (*l->tab->Getarg)(aTHX_ &l, 0, 0) : &PL_sv_undef;
	       av_push(av, name);
	       av_push(av, arg);
	       av_push(av, newSViv((IV)l->flags));
	       l = l->next;
	  }
     }

     return av;
}
