HV*
Perl_avhv_keys(pTHX_ AV *av)
{
    SV **keysp = av_fetch(av, 0, FALSE);
    if (keysp) {
	SV *sv = *keysp;
	if (SvGMAGICAL(sv))
	    mg_get(sv);
	if (SvROK(sv)) {
            if (ckWARN(WARN_DEPRECATED) && !sv_isa(sv, "pseudohash"))
	        Perl_warner(aTHX_ packWARN(WARN_DEPRECATED),
			    "Pseudo-hashes are deprecated");
	    sv = SvRV(sv);
	    if (SvTYPE(sv) == SVt_PVHV)
		return (HV*)sv;
	}
    }
    Perl_croak(aTHX_ "Can't coerce array into hash");
    return Nullhv;
}
