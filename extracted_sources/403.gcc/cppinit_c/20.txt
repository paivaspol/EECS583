bool
_cpp_push_next_buffer (pfile)
     cpp_reader *pfile;
{
  bool pushed = false;

  /* This is't pretty; we'd rather not be relying on this as a boolean
     for reverting the line map.  Further, we only free the chains in
     this conditional, so an early call to cpp_finish / cpp_destroy
     will leak that memory.  */
  if (CPP_OPTION (pfile, pending)
      && CPP_OPTION (pfile, pending)->imacros_head == NULL)
    {
      while (!pushed)
	{
	  struct pending_option *p = CPP_OPTION (pfile, pending)->include_head;

	  if (p == NULL)
	    break;
	  if (! CPP_OPTION (pfile, preprocessed))
	    pushed = push_include (pfile, p);
	  CPP_OPTION (pfile, pending)->include_head = p->next;
	  free (p);
	}

      if (!pushed)
	{
	  free (CPP_OPTION (pfile, pending));
	  CPP_OPTION (pfile, pending) = NULL;

	  /* Restore the line map for the main file.  */
	  if (! CPP_OPTION (pfile, preprocessed))
	    _cpp_do_file_change (pfile, LC_RENAME,
				 pfile->line_maps.maps[0].to_file, 1, 0);
	}
    }

  return pushed;
}
